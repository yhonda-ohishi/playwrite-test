name: Build & Push to GitHub Container Registry

on:

  push:
    branches: [ "main" ] # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã¨ãã«ãƒˆãƒªã‚¬ãƒ¼
  pull_request:
    branches: [ "main" ] # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã£ãŸã¨ãã«ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹


env:
  # ã‚¤ãƒ¡ãƒ¼ã‚¸åã¯ãƒªãƒã‚¸ãƒˆãƒªåã¨ä¸€è‡´ã•ã›ã‚‹ã®ãŒä¸€èˆ¬çš„
  # ã“ã“ã§ã¯å°æ–‡å­—ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚
  IMAGE_NAME: dtako_server # ã‚¤ãƒ¡ãƒ¼ã‚¸åï¼ˆãƒªãƒã‚¸ãƒˆãƒªåï¼‰

jobs:
  build_and_push_image:
    # runs-on: ubuntu-latest # ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹OS
    runs-on: self-hosted # ã“ã“ãŒé‡è¦ï¼Self-hosted runner ã‚’æŒ‡å®š



    permissions:
      contents: read       # ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹æ¨©é™
      packages: write      # GHCRã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ã‚’æ›¸ãè¾¼ã‚€æ¨©é™

    steps:
    - name: Checkout repository # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4



      # ğŸ‘‡ ã“ã“ã‹ã‚‰æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¾ã™ï¼
    - name: Start Docker daemon inside runner container # runnerã‚³ãƒ³ãƒ†ãƒŠå†…ã§Dockerãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’èµ·å‹•
      run: |
          # Dockerãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
          sudo dockerd &
          
          # Dockerãƒ‡ãƒ¼ãƒ¢ãƒ³ãŒå®Œå…¨ã«èµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
          echo "Dockerãƒ‡ãƒ¼ãƒ¢ãƒ³ã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
          TIMEOUT=60 # æœ€å¤§å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰
          for i in $(seq 1 <span class="math-inline">TIMEOUT\); do
          if sudo docker info \> /dev/null 2\>&1; then
          echo "Dockerãƒ‡ãƒ¼ãƒ¢ãƒ³ã¯</span>{i}ç§’å¾Œã«æ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸã€‚"
              break
            fi
            echo "è©¦è¡Œ <span class="math-inline">\{i\}/</span>{TIMEOUT}: Dockerãƒ‡ãƒ¼ãƒ¢ãƒ³ã¯ã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ã€‚å¾…æ©Ÿä¸­..."
            sleep 1
          done
          
          # Dockerãƒ‡ãƒ¼ãƒ¢ãƒ³ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€èµ·å‹•ã—ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†
          if ! sudo docker info > /dev/null 2>&1; then
            echo "ã‚¨ãƒ©ãƒ¼: Dockerãƒ‡ãƒ¼ãƒ¢ãƒ³ãŒæ™‚é–“å†…ã«èµ·å‹•ã—ã¾ã›ã‚“ã§ã—ãŸï¼"
            exit 1
          fi
      # ğŸ‘† ã“ã“ã¾ã§æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—

    - name: Log in to the Container registry # ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ãƒ­ã‚°ã‚¤ãƒ³
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: <span class="math-inline">\{\{ secrets\.GITHUB\_TOKEN \}\} \# ã“ã‚ŒãŒé‡è¦

    # - name: Log in to the Container registry
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ghcr.io
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }} # ã“ã‚ŒãŒé‡è¦
        

    # - name: Set up Docker Buildx # Docker Buildx ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    #   uses: docker/setup-buildx-action@v3

    # - name: Build and push Docker image # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦GHCRã«ãƒ—ãƒƒã‚·ãƒ¥
    #   uses: docker/build-push-action@v5
    #   with:
    #     context: . # DockerfileãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    #     push: true # GHCRã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
    #     tags: |
    #       ghcr.io/${{ github.repository }}:${{ github.sha }} # ã‚³ãƒŸãƒƒãƒˆSHAã‚’ã‚¿ã‚°ã¨ã—ã¦ä½¿ç”¨
    #       ghcr.io/${{ github.repository }}:latest          
        # build-args: | # <-- ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        #   GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}